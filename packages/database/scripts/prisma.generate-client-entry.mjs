import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

const colors = {
  reset: "\x1b[0m",
  red: "\x1b[31m",
  green: "\x1b[32m",
  yellow: "\x1b[33m",
  cyan: "\x1b[36m",
};

const log = {
  info: (msg) => console.log(`${colors.cyan}[INFO]${colors.reset} ${msg}`),
  success: (msg) =>
    console.log(`${colors.green}[SUCCESS]${colors.reset} ${msg}`),
  warn: (msg) => console.warn(`${colors.yellow}[WARN] ${msg}`),
  error: (msg) => console.error(`${colors.red}[ERROR] ${msg}`),
};

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const ROOT_DIR = path.resolve(__dirname, "..");
const SRC_DIR = path.resolve(ROOT_DIR, "src");
const PRISMA_DIR = path.resolve(SRC_DIR, "prisma");
const GENERATED_DIR = path.resolve(PRISMA_DIR, "generated");
const OUTPUT_FILE = path.resolve(PRISMA_DIR, "client-factory.generated.ts");

log.info(`Scanning generated clients in: ${GENERATED_DIR}`);

if (!fs.existsSync(GENERATED_DIR)) {
  log.error("Generated folder not found. Please run prisma generate first.");
  process.exit(1);
}

const schemas = fs.readdirSync(GENERATED_DIR).filter((file) => {
  const dirPath = path.join(GENERATED_DIR, file);

  const hasClient = fs.existsSync(path.join(dirPath, "client.ts"));
  if (!fs.statSync(dirPath).isDirectory()) {
    return false;
  }

  if (!hasClient) {
    log.warn(`Skipping folder '${file}': 'client.ts' not found inside.`);
    return false;
  }
  return true;
});

if (schemas.length === 0) {
  log.error(
    "No valid schema folders (with client.ts) found in src/prisma/generated.",
  );
  process.exit(1);
}

log.info(`Found valid clients: ${schemas.join(", ")}`);

const imports = schemas
  .map(
    (schema) =>
      `import { PrismaClient as ${capitalize(schema)}Client, Prisma as ${capitalize(schema)}Prisma } from './generated/${schema}/client';`,
  )
  .join("\n");

const clientMap = schemas
  .map((schema) => `  ${schema}: ${capitalize(schema)}Client;`)
  .join("\n");

const constructorMap = schemas
  .map((schema) => `  ${schema}: ${capitalize(schema)}Client,`)
  .join("\n");

const logLevelMap = schemas
  .map((schema) => `  ${schema}: ${capitalize(schema)}Prisma.LogLevel;`)
  .join("\n");

const content = `/**
 * THIS FILE IS AUTOMATICALLY GENERATED. DO NOT EDIT MANUALLY.
 * Run "node scripts/generate-client-entry.mjs" to update.
 */
${imports}

export type AvailableSchemas = '${schemas.join("' | '")}';

export type SchemaClientMap = {
${clientMap}
};

export type SchemaLogLevelMap = {
${logLevelMap}
};

export const SCHEMA_CONSTRUCTORS = {
${constructorMap}
};

export type { ${schemas.map((s) => `${capitalize(s)}Prisma`).join(", ")} };
`;

fs.writeFileSync(OUTPUT_FILE, content, "utf-8");
log.success(`Generated entry file at: ${OUTPUT_FILE}`);

function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}
